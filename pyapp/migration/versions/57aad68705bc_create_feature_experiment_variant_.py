"""create, feature, experiment, variant, decision table

Revision ID: 57aad68705bc
Revises: 
Create Date: 2025-12-22 18:08:02.813963

"""
from typing import Sequence, Union

from repositories.db.init import JSONField
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '57aad68705bc'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('features',
    sa.Column('id', sa.String(length=64), nullable=False, comment='Primary key'),
    sa.Column('key', sa.String(length=128), nullable=False, comment='Feature key'),
    sa.Column('name', sa.String(length=255), nullable=False, comment='Display name'),
    sa.Column('status', sa.String(length=32), nullable=False, comment='Status: off/on/experiment'),
    sa.Column('active_experiment_id', sa.String(length=64), nullable=True, comment='active experiment id'),
    sa.ForeignKeyConstraint(['active_experiment_id'], ['experiments.id'], name='fk_feature_active_experiment', use_alter=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('key', name='uq_feature_key'),
    comment='Feature flags'
    )
    op.create_table('experiments',
    sa.Column('id', sa.String(length=64), nullable=False, comment='Primary key'),
    sa.Column('feature_id', sa.String(length=64), nullable=False, comment='Feature id'),
    sa.Column('name', sa.String(length=255), nullable=False, comment='Experiment name'),
    sa.Column('status', sa.String(length=32), nullable=False, comment='Status: draft/running/paused'),
    sa.Column('seed', sa.String(length=64), nullable=False, comment='Bucketing seed'),
    sa.Column('rollout_percent', sa.Integer(), nullable=False, comment='Rollout percent(0-100)'),
    sa.ForeignKeyConstraint(['feature_id'], ['features.id'], name='fk_experiment_feature_id'),
    sa.PrimaryKeyConstraint('id'),
    comment='Experiment configuration'
    )
    op.create_index(op.f('ix_experiments_feature_id'), 'experiments', ['feature_id'], unique=False)
    op.create_table('variants',
    sa.Column('id', sa.String(length=64), nullable=False, comment='Primary key'),
    sa.Column('experiment_id', sa.String(length=64), nullable=False, comment='Experiment id'),
    sa.Column('key', sa.String(length=64), nullable=False, comment='Variant key'),
    sa.Column('weight', sa.Integer(), nullable=False, comment='Allocation weight'),
    sa.Column('is_control', sa.Boolean(), nullable=False, comment='Is control variant'),
    sa.Column('payload', JSONField(), nullable=False, comment='Variant payload JSON'),
    sa.ForeignKeyConstraint(['experiment_id'], ['experiments.id'], name='fk_variant_experiment_id'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('experiment_id', 'key', name='uq_variant_experiment_key'),
    comment='Experiment variants'
    )
    op.create_index(op.f('ix_variants_experiment_id'), 'variants', ['experiment_id'], unique=False)
    op.create_table('decisions',
    sa.Column('id', sa.String(length=64), nullable=False, comment='Primary key'),
    sa.Column('request_id', sa.String(length=64), nullable=False, comment='Idempotency request id'),
    sa.Column('experiment_id', sa.String(length=64), nullable=True, comment='Experiment id'),
    sa.Column('user_id', sa.String(length=64), nullable=False, comment='User id'),
    sa.Column('variant_id', sa.String(length=64), nullable=True, comment='Variant id'),
    sa.Column('reason', sa.String(length=32), nullable=False, comment='Decision reason'),
    sa.Column('decided_at', sa.DateTime(), nullable=False, comment='Decision time (UTC)'),
    sa.ForeignKeyConstraint(['experiment_id'], ['experiments.id'], name='fk_decision_experiment_id'),
    sa.ForeignKeyConstraint(['variant_id'], ['variants.id'], name='fk_decision_variant_id'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('request_id', name='uq_decision_request_id'),
    comment='Decision audit log'
    )
    op.create_index(op.f('ix_decisions_experiment_id'), 'decisions', ['experiment_id'], unique=False)
    op.create_index(op.f('ix_decisions_user_id'), 'decisions', ['user_id'], unique=False)
    op.create_index(op.f('ix_decisions_variant_id'), 'decisions', ['variant_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_decisions_variant_id'), table_name='decisions')
    op.drop_index(op.f('ix_decisions_user_id'), table_name='decisions')
    op.drop_index(op.f('ix_decisions_experiment_id'), table_name='decisions')
    op.drop_table('decisions')
    op.drop_index(op.f('ix_variants_experiment_id'), table_name='variants')
    op.drop_table('variants')
    op.drop_index(op.f('ix_experiments_feature_id'), table_name='experiments')
    op.drop_table('experiments')
    op.drop_table('features')
    # ### end Alembic commands ###
